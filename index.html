<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>40k Weapon vs Defense Calculator</title>
  <link rel="stylesheet" href="styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
<div class="app" :class="sidebarCollapsed ? 'sidebar-collapsed' : ''" x-data="weaponVsDefenseApp()" x-init="init()">
  <aside id="sidebar">
    <div class="asideHead">
      <h1>Army Loader</h1>
      <button type="button" class="secondary iconBtn" aria-controls="sidebar" :aria-expanded="(!sidebarCollapsed).toString()" x-text="sidebarCollapsed ? '⟩' : '⟨'" @click="sidebarCollapsed = !sidebarCollapsed"
      ></button>
    </div>

    <div class="card">
      <div class="row">
        <input type="file" accept=".json" @change="onRosterFile($event)" />
        <button class="secondary" type="button" @click="loadPastedRoster()">Load pasted JSON</button>
      </div>

      <label>
        Paste JSON (optional)
        <textarea x-model="jsonPaste" rows="6" placeholder="Paste your roster JSON here and click 'Load pasted JSON'"></textarea>
      </label>

      <div class="row">
        <label>
          Roster
          <select x-model.number="selectedRosterIdx" @change="refreshForces()">
            <template x-for="(r, i) in rosters" :key="`roster-${i}`">
              <option :value="i" x-text="r.label || `Roster ${i+1}`"></option>
            </template>
            <template x-if="rosters.length === 0">
              <option value="0">No rosters loaded</option>
            </template>
          </select>
        </label>

        <button class="secondary" type="button" style="align-self:flex-end" :disabled="rosters.length === 0" @click="removeRoster(selectedRosterIdx)"> Remove roster
        </button>
      </div>

      <div class="row">
        <label>
          Force
          <select x-model.number="selectedForceIdx" @change="refreshUnits()">
            <template x-for="(f, i) in forces" :key="`force-${i}`">
              <option :value="i" x-text="f.name || `Force ${i+1}`"></option>
            </template>
            <template x-if="forces.length === 0">
              <option value="0">No forces found</option>
            </template>
          </select>
        </label>
      </div>

      <div class="row">
        <label>
          Unit / Model
          <select x-model.number="selectedUnitIdx" @change="onUnitChanged()">
            <template x-for="(u, i) in units" :key="`unit-${i}`">
              <option :value="i" x-text="u.label || `Unit ${i+1}`"></option>
            </template>
            <template x-if="units.length === 0">
              <option value="0">No units found</option>
            </template>
          </select>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button type="button" class="primary" @click="openMatchupModal()" :disabled="rosters.length === 0">Unit Matchups</button>
      </div>
    </div>

    <h2>Pick a weapon</h2>
    <div class="card" id="weaponList">
      <template x-if="!activeWeapons || activeWeapons.length === 0">
        <div class="muted">Load an army then choose a unit to see its weapons.</div>
      </template>

      <template x-if="activeWeapons && activeWeapons.length > 0">
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Name</th><th>Range</th><th>A</th><th>SKILL</th><th>S</th><th>AP</th><th>D</th><th>Modifiers</th><th></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(w, i) in activeWeapons" :key="`wpn-${i}`">
                <tr>
                  <td x-text="w.name || ''"></td>
                  <td x-text="w.range || ''"></td>
                  <td x-text="w.A || ''"></td>
                  <td x-text="w.skill || ''"></td>
                  <td x-text="w.S || ''"></td>
                  <td x-text="w.AP || ''"></td>
                  <td x-text="w.D || ''"></td>
                  <td>
                    <template x-if="(w.modifiers || '').trim().length === 0">
                      <span class="muted">—</span>
                    </template>
                    <template x-if="(w.modifiers || '').trim().length > 0">
                      <span>
                        <template x-for="(k, ki) in (w.modifiers || '').split(',').map(x=>x.trim()).filter(Boolean)" :key="`kw-${i}-${ki}`">
                          <span class="modifier" x-text="k"></span>
                        </template>
                      </span>
                    </template>
                  </td>
                  <td>
                    <button class="secondary" type="button" @click="loadWeapon(w)">Load</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </div>

    <h2>Unit Defense</h2>
    <div class="card" id="unitDefense">
      <template x-if="!activeUnit">
        <div class="muted">Select a unit to see its defensive profile.</div>
      </template>

      <template x-if="activeUnit">
        <div>
          <div class="muted" style="margin-bottom:6px" x-text="activeUnit.label || 'Unit'"></div>
          <div x-html="renderDefensePills(activeUnit.defense)"></div>
        </div>
      </template>
    </div>

    <div class="row">
      <button class="secondary" type="button" @click="loadSelectedDefenseIntoForm()">Load defensive profile</button>
    </div>

    <h2>Presets</h2>

    <div class="card">
      <h3 class="muted" style="margin:0 0 10px;">Infantry</h3>
      <div class="row">
        <button class="secondary" type="button" @click="applyPreset(3, 5, 0, false, 0, 0, 1)"><!--(T,Sv,Inv,cover,DR,Fnp,W) -->
          Guardsman (T3, 5+, 1W)
        </button>

        <button class="secondary" type="button" @click="applyPreset(4, 3, 0, false, 0, 0, 2)"><!--(T,Sv,Inv,cover,DR,Fnp,W) -->
          Marine (T4, 3+, 2W)
        </button>

        <button class="secondary" type="button" @click="applyPreset(6, 2, 4, false, 0, 0, 3)"><!--(T,Sv,Inv,cover,DR,Fnp,W) -->
          Elite (Custodes) (T6, 2+/4++, 3W)
        </button>
      </div>
    </div>

    <div class="card">
      <h3 class="muted" style="margin:0 0 10px;">Vehicles</h3>
      <div class="row">
        <button class="secondary" type="button" @click="applyPreset(9, 3, 0, false, 0, 0, 12)"><!--(T,Sv,Inv,cover,DR,Fnp,W) -->
          Rhino (T9, 3+, 12W)
        </button>
      </div>
    </div>
  </aside>

  <button type="button" class="secondary sidebarHandle" aria-controls="sidebar" :aria-expanded="(!sidebarCollapsed).toString()" @click="sidebarCollapsed = false"
  > ⟩ </button>

  <main>
    <h1 style="padding-left:15px">Weapon vs Defense Calculator</h1>

    <div class="grid">
      <!-- Weapon -->
      <div class="card">
        <h2>Weapon Profile</h2>

        <div class="grid">
          <label>A (Attacks)<input class="smallInput" x-model="weapon.A" inputmode="numeric" /></label>
          <label>BS/WS (Skill)<input class="smallInput" x-model="weapon.skill" inputmode="numeric" /></label>
          <label>S (Strength)<input class="smallInput" x-model="weapon.S" inputmode="numeric" /></label>
          <label>AP (Armor Pen)<input class="smallInput" x-model="weapon.AP" inputmode="numeric" /></label>
          <label>D (Damage)<input class="smallInput" x-model="weapon.D" inputmode="numeric" /></label>
        </div>

        <!-- Weapon-side modifiers -->
        <div class="grid">
          <div class="row" style="gap:6px;align-items:flex-end;">
            <label style="flex:1;width:100px">
              Weapon-side modifiers
              <select style="min-width:220px" x-model="modAdd.key" @change="syncModValueDefault()">
                <template x-for="m in MODIFIERS" :key="m.key">
                  <option :value="m.key" x-text="m.label"></option>
                </template>
              </select>
            </label>

            <label style="min-width:50px;flex:1;margin-right:100px;">
              Value
              <div class="kwValueRow">
                <!-- numeric -->
                <template x-if="modDef(modAdd.key)?.type === 'number'">
                  <input type="number" step="1" x-model.number="modAdd.value"
                  />
                </template>

                <!-- select -->
                <template x-if="modDef(modAdd.key)?.type === 'select'">
                  <select x-model="modAdd.value" style="min-width:160px">
                    <template x-for="opt in (modDef(modAdd.key)?.options || [])" :key="opt.value">
                      <option :value="opt.value" x-text="opt.label"></option>
                    </template>
                  </select>
                </template>

                <!-- flag -->
                <template x-if="modDef(modAdd.key)?.type === 'flag'">
                  <input class="disabled" disabled value="—" />
                </template>

                <button type="button" class="secondary" @click="addModifierTag()">Add</button>
              </div>
            </label>
          </div>
        </div>
        
        <div class="grid">
          <div style="min-width:40px;flex:1;">
            <div style="margin-top:8px">
              <template x-if="modifierTags.length === 0">
                <div class="muted">No modifiers added.</div>
              </template>

              <template x-for="(t, i) in modifierTags" :key="`tag-${t.key}`">
                <span class="pill tagPill">
                  <span x-text="normalizeModifierDisplay(t)"></span>
                  <button type="button" class="secondary tagX" @click="removeModifierTag(i)">x</button>
                </span>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Defense -->
      <div class="card">
        <h2>Defensive Profile</h2>

        <div class="grid">
          <label>Toughness (T) <input type="number" x-model="defense.T" /></label>
          <label>Save (SV)<input class="smallInput" x-model="defense.Sv" inputmode="numeric" /></label>
          <label>Invuln<input class="smallInput" x-model="defense.Inv" inputmode="numeric" placeholder="" /></label>
          <label>Wounds Each<input type="number" x-model="defense.W" /></label>
          <label>Feel No Pain<input class="smallInput" x-model="defense.Fnp" inputmode="numeric" placeholder="" /></label>
          <label>Dmg Reduction <input class="smallInput" type="number" x-model="defense.DR" /></label>
          <label>Total Models <input class="smallInput" type="number" min="1" x-model="defense.models" /></label>
          <label style="align-items: flex-start;">Cover?<input style="width:20px;height:20px;" type="checkbox" x-model="defense.cover"></label>
        </div>
      </div>
    </div>

    <div class="row" style="margin:12px 0">
      <button type="button" @click="calculate()">Calculate</button>
      <button class="secondary" type="button" @click="resetOutput()">Reset</button>
      <span class="muted">All math is expectation-based (averages). Handles NdX and NdX±C in Attacks.</span>
    </div>

    <div class="metrics">
      <div class="metric"><div class="muted">Expected Hits</div><div class="v" x-text="fmtOut(output.hits)"></div></div>
      <div class="metric"><div class="muted">Expected Wounds</div><div class="v" x-text="fmtOut(output.wounds)"></div></div>
      <div class="metric"><div class="muted">Failed Saves</div><div class="v" x-text="fmtOut(output.fails)"></div></div>
      <div class="metric"><div class="muted">Expected Damage</div><div class="v" x-text="fmtOut(output.dmg)"></div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>Breakdown</h2>
      <div class="muted" x-html="output.breakdownHtml || 'No calculation yet.'"></div>

      <div class="chartWrap">
        <canvas id="breakdownChart" x-ref="chart" height="220"></canvas>
        <div class="chartHint">Y: expected damage | X: resolution steps (attacks → hits → wounds → saves → damage → FNP)</div>
      </div>
    </div>

    <div class="footer">
      Designed for quick list-tech and what-if analysis. Assumes standard 10e crits on unmodified rolls and applies re-rolls before crit checks.
      Torrent auto-hits supported via the Torrent Modifier tag. Modifier are applied from the tag system.
    </div>
  </main>

  <!-- Unit Matchups modal -->
  <div class="modalOverlay" x-show="matchupModalOpen" x-cloak
       @keydown.escape.window="closeMatchupModal()" @click.self="closeMatchupModal()">
    <div class="modal modalWide" role="dialog" aria-modal="true" aria-label="Unit matchups">
      <div class="modalHead">
        <div style="display:flex;flex-direction:column;gap:4px">
          <div style="font-weight:800">Unit Matchups</div>
          <div class="muted" style="font-size:12px">
            Each cell adds up the total damage of the best selectable weapon profiles on each attacker unit.
          </div>
        </div>
        <button class="secondary" type="button" @click="closeMatchupModal()">Close</button>
      </div>

      <div class="modalBody">
        <div class="matchupControls">
          <div class="matchupSide">
            <div class="muted" style="margin-bottom:6px">Attacker</div>
            <div class="row">
              <label>
                Roster
                <select x-model.number="matchup.attackerRosterIdx" @change="onMatchupRosterChanged('attacker')">
                  <template x-for="(r, i) in rosters" :key="`m-atk-r-${i}`">
                    <option :value="i" x-text="r.label || `Roster ${i+1}`"></option>
                  </template>
                </select>
              </label>
              <label>
                Force
                <select x-model.number="matchup.attackerForceIdx" @change="rebuildMatchup()">
                  <template x-for="(f, i) in matchupAttackerForces" :key="`m-atk-f-${i}`">
                    <option :value="i" x-text="f.name || `Force ${i+1}`"></option>
                  </template>
                </select>
              </label>
            </div>

            <div class="row">
              <label>
                Sort attackers
                <select x-model="matchup.sortAttackers" @change="applyMatchupSorting()">
                  <option value="alpha">Alphabetical</option>
                  <option value="pkill">Highest % unit killed</option>
                  <option value="dmg">Highest damage</option>
                </select>
              </label>
            </div>
          </div>

          <div class="matchupSide">
            <div class="muted" style="margin-bottom:6px">Defender</div>
            <div class="row">
              <label>
                Roster
                <select x-model.number="matchup.defenderRosterIdx" @change="onMatchupRosterChanged('defender')">
                  <template x-for="(r, i) in rosters" :key="`m-def-r-${i}`">
                    <option :value="i" x-text="r.label || `Roster ${i+1}`"></option>
                  </template>
                </select>
              </label>
              <label>
                Force
                <select x-model.number="matchup.defenderForceIdx" @change="rebuildMatchup()">
                  <template x-for="(f, i) in matchupDefenderForces" :key="`m-def-f-${i}`">
                    <option :value="i" x-text="f.name || `Force ${i+1}`"></option>
                  </template>
                </select>
              </label>
            </div>

            <div class="row">
              <label>
                Sort defenders
                <select x-model="matchup.sortDefenders" @change="applyMatchupSorting()">
                  <option value="alpha">Alphabetical</option>
                  <option value="pkill">Highest % unit killed</option>
                  <option value="dmg">Highest damage</option>
                </select>
              </label>
            </div>
          </div>

          <div class="matchupToggles">
            <button type="button" class="seg" @click="swapMatchupSides()">
              Swap sides
            </button>

            <div class="segRow">
              <button type="button" class="seg" :class="matchup.combineShootingProfiles ? 'active' : ''" @click="matchup.combineShootingProfiles=!matchup.combineShootingProfiles; rebuildMatchup()">
                Combine shooting profiles
              </button>
            </div>

            <div class="segRow">
              <button type="button" class="seg" :class="matchup.showShooting ? 'active' : ''" @click="matchup.showShooting=!matchup.showShooting; rebuildMatchup()">
                Shooting
              </button>
              <button type="button" class="seg" :class="matchup.showMelee ? 'active' : ''" @click="matchup.showMelee=!matchup.showMelee; rebuildMatchup()">
                Melee
              </button>
              <button type="button" class="secondary" :class="matchup.opts.separateModels ? 'active' : ''" @click="matchup.opts.separateModels = !matchup.opts.separateModels; rebuildMatchup()" title="If ON: each model entry becomes its own row/column. If OFF: models are grouped into their parent unit.">
                Split models
              </button>
            </div>
          </div>

          <div class="row" style="align-items:flex-end;justify-content:flex-end">
            <button type="button" @click="rebuildMatchup()" :disabled="rosters.length === 0">Recompute</button>
          </div>
        </div>

        <template x-if="matchup.loading">
          <div class="muted" style="padding:10px">Computing matchup grid…</div>
        </template>

        <template x-if="!matchup.loading">
          <div class="matchupGridWrap">
            <table class="matchupGrid">
              <thead>
                <tr>
                  <th class="stickyCol">Attacker ↓<br><span class="muted">Defender →</span></th>
                  <template x-for="(du, di) in matchupDefenderUnits" :key="`m-col-${di}`">
                    <th>
                      <div x-text="du.label || `Def ${di+1}`"></div>
                      <div class="muted" style="font-size:11px" x-text="matchupDefenseLabel(du)"></div>
                    </th>
                  </template>
                </tr>
              </thead>
              <tbody>
                <template x-for="(au, ai) in matchupAttackerUnits" :key="`m-row-${ai}`">
                  <tr>
                    <th class="stickyCol">
                      <div x-text="au.label || `Atk ${ai+1}`"></div>
                      <div class="muted" style="font-size:11px" x-text="matchupWeaponSummary(au)"></div>
                    </th>

                    <template x-for="(cell, di) in matchup.rows?.[ai]?.cells" :key="`m-cell-${ai}-${di}`">
                      <td>
                        <div style="font-weight:800" x-text="fmtOut(cell.dmg)"></div>
                        <div class="muted" style="font-size:11px" x-text="`kills: ${fmtOut(cell.kills)}`"></div>
                        <template x-if="cell.pctKilled != null">
                          <div class="muted" style="font-size:11px" x-text="`% unit: ${fmtPct(cell.pctKilled)}`"></div>
                        </template>
                        <template x-if="cell.weaponName">
                          <div class="muted" style="font-size:11px" x-text="cell.weaponName"></div>
                        </template>
                      </td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>
      </div>
    </div>
  </div>

</div>

<script src="utilities.js"></script>
</body>
</html>
